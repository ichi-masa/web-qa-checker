export function generateMarkdown(report) {
  const { url, date, pages } = report;
  let md = [];

  // ãƒ˜ãƒƒãƒ€ãƒ¼
  md.push(`# Webå“è³ªãƒã‚§ãƒƒã‚¯ãƒ¬ãƒãƒ¼ãƒˆ`);
  md.push('');
  md.push(`**å¯¾è±¡ã‚µã‚¤ãƒˆ:** ${url}`);
  md.push(`**å®Ÿæ–½æ—¥:** ${date}`);
  md.push(`**ãƒã‚§ãƒƒã‚¯ãƒšãƒ¼ã‚¸æ•°:** ${pages.length}ãƒšãƒ¼ã‚¸`);
  md.push('');
  md.push('---');
  md.push('');

  // ã‚µãƒãƒªãƒ¼çµ±è¨ˆ
  const summary = calculateSummary(pages);
  md.push('## ğŸ“Š ã‚µãƒãƒªãƒ¼');
  md.push('');
  md.push('| é …ç›® | çµæœ |');
  md.push('|------|------|');
  md.push(`| ç·ã‚¨ãƒ©ãƒ¼æ•° | ${summary.totalErrors} |`);
  md.push(`| ç·è­¦å‘Šæ•° | ${summary.totalWarnings} |`);
  md.push(`| å¹³å‡Lighthouseã‚¹ã‚³ã‚¢ | ${summary.avgLighthouse || 'N/A'} |`);
  md.push(`| æœ€ä½Lighthouseã‚¹ã‚³ã‚¢ | ${summary.minLighthouse || 'N/A'} |`);
  md.push('');

  // é‡è¦ãªå•é¡Œã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
  if (summary.criticalIssues.length > 0) {
    md.push('### âš ï¸ é‡è¦ãªå•é¡Œ');
    md.push('');
    summary.criticalIssues.forEach(issue => {
      md.push(`- ${issue}`);
    });
    md.push('');
  }

  md.push('---');
  md.push('');

  // å„ãƒšãƒ¼ã‚¸ã®è©³ç´°
  md.push('## ğŸ“„ ãƒšãƒ¼ã‚¸ã”ã¨ã®è©³ç´°');
  md.push('');

  pages.forEach((page, pageIndex) => {
    md.push(`### ${pageIndex + 1}. ${page.path}`);
    md.push('');
    md.push(`**URL:** ${page.url}`);
    md.push(`**ã‚¿ã‚¤ãƒˆãƒ«:** ${page.title || 'N/A'}`);
    md.push('');

    // å„ãƒã‚§ãƒƒã‚¯é …ç›®ã®çµæœ
    page.checks.forEach(check => {
      if (!check) return;

      md.push(`#### ${check.name}`);
      md.push('');

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
      const statusEmoji = getStatusEmoji(check.status);
      md.push(`**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:** ${statusEmoji} ${check.status}`);
      md.push('');

      // ã‚¨ãƒ©ãƒ¼ã¨è­¦å‘Š
      if (check.errors && check.errors.length > 0) {
        md.push('**ã‚¨ãƒ©ãƒ¼:**');
        check.errors.forEach(error => {
          md.push(`- ğŸ”´ ${error}`);
        });
        md.push('');
      }

      if (check.warnings && check.warnings.length > 0) {
        md.push('**è­¦å‘Š:**');
        check.warnings.forEach(warning => {
          md.push(`- ğŸŸ¡ ${warning}`);
        });
        md.push('');
      }

      // Lighthouseç‰¹åˆ¥å‡¦ç†
      if (check.name === 'Lighthouse' && check.scores) {
        md.push('**ã‚¹ã‚³ã‚¢:**');
        md.push('');
        md.push('| ã‚«ãƒ†ã‚´ãƒª | ã‚¹ã‚³ã‚¢ | è©•ä¾¡ |');
        md.push('|----------|--------|------|');

        Object.entries(check.scores).forEach(([category, score]) => {
          const emoji = getScoreEmoji(score);
          const categoryName = getCategoryName(category);
          md.push(`| ${categoryName} | ${score} | ${emoji} |`);
        });
        md.push('');
      }

      // ãã®ä»–ã®è©³ç´°æƒ…å ±
      if (check.details) {
        md.push('**è©³ç´°:**');
        if (Array.isArray(check.details)) {
          check.details.forEach(detail => {
            md.push(`- ${detail}`);
          });
        } else if (typeof check.details === 'object') {
          Object.entries(check.details).forEach(([key, value]) => {
            if (Array.isArray(value) && value.length > 0) {
              md.push(`- **${key}:** ${value.length}ä»¶`);
              value.slice(0, 5).forEach(item => {
                md.push(`  - ${item}`);
              });
              if (value.length > 5) {
                md.push(`  - ... ä»–${value.length - 5}ä»¶`);
              }
            } else if (value) {
              md.push(`- **${key}:** ${value}`);
            }
          });
        }
        md.push('');
      }
    });

    // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæƒ…å ±
    if (page.screenshots && page.screenshots.length > 0) {
      md.push('#### ğŸ“¸ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ');
      md.push('');
      md.push('| ãƒ‡ãƒã‚¤ã‚¹ | ãƒ•ã‚¡ã‚¤ãƒ« |');
      md.push('|----------|----------|');
      page.screenshots.forEach(screenshot => {
        md.push(`| ${screenshot.device} | [${screenshot.filename}](${screenshot.filename}) |`);
      });
      md.push('');
    }

    md.push('---');
    md.push('');
  });

  // ãƒ•ãƒƒã‚¿ãƒ¼
  md.push('## ğŸ”§ æ¨å¥¨äº‹é …');
  md.push('');
  md.push(generateRecommendations(summary));
  md.push('');
  md.push('---');
  md.push('');
  md.push(`*Generated by qa-check-tool on ${new Date().toLocaleString('ja-JP')}*`);

  return md.join('\n');
}

function calculateSummary(pages) {
  let totalErrors = 0;
  let totalWarnings = 0;
  let lighthouseScores = [];
  let criticalIssues = [];

  pages.forEach(page => {
    page.checks.forEach(check => {
      if (check.errors) {
        totalErrors += check.errors.length;

        // ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãªå•é¡Œã‚’æ¤œå‡º
        if (check.errors.length > 0 && check.name === 'ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼') {
          criticalIssues.push(`${page.path}: JavaScriptã‚¨ãƒ©ãƒ¼ãŒ${check.errors.length}ä»¶æ¤œå‡ºã•ã‚Œã¾ã—ãŸ`);
        }
        if (check.name === 'SEOãƒã‚§ãƒƒã‚¯' && check.errors.some(e => e.includes('title') || e.includes('description'))) {
          criticalIssues.push(`${page.path}: SEOå¿…é ˆè¦ç´ ãŒä¸è¶³ã—ã¦ã„ã¾ã™`);
        }
      }

      if (check.warnings) {
        totalWarnings += check.warnings.length;
      }

      // Lighthouseã‚¹ã‚³ã‚¢é›†è¨ˆ
      if (check.name === 'Lighthouse' && check.scores) {
        const avgScore = Object.values(check.scores).reduce((a, b) => a + b, 0) / Object.values(check.scores).length;
        lighthouseScores.push(avgScore);
      }
    });
  });

  const avgLighthouse = lighthouseScores.length > 0
    ? Math.round(lighthouseScores.reduce((a, b) => a + b, 0) / lighthouseScores.length)
    : null;

  const minLighthouse = lighthouseScores.length > 0
    ? Math.round(Math.min(...lighthouseScores))
    : null;

  return {
    totalErrors,
    totalWarnings,
    avgLighthouse,
    minLighthouse,
    criticalIssues
  };
}

function getStatusEmoji(status) {
  const statusMap = {
    'pass': 'âœ…',
    'warning': 'âš ï¸',
    'error': 'âŒ',
    'info': 'â„¹ï¸'
  };
  return statusMap[status] || 'â“';
}

function getScoreEmoji(score) {
  if (score >= 90) return 'ğŸŸ¢ å„ªç§€';
  if (score >= 50) return 'ğŸŸ¡ è¦æ”¹å–„';
  return 'ğŸ”´ è¦å¯¾å¿œ';
}

function getCategoryName(category) {
  const categoryMap = {
    'performance': 'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹',
    'accessibility': 'ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£',
    'best-practices': 'ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹',
    'seo': 'SEO',
    'pwa': 'PWA'
  };
  return categoryMap[category] || category;
}

function generateRecommendations(summary) {
  const recommendations = [];

  if (summary.totalErrors > 0) {
    recommendations.push(`1. **ã‚¨ãƒ©ãƒ¼ã®è§£æ¶ˆã‚’æœ€å„ªå…ˆã§å®Ÿæ–½ã—ã¦ãã ã•ã„** (${summary.totalErrors}ä»¶ã®ã‚¨ãƒ©ãƒ¼)`);
  }

  if (summary.avgLighthouse && summary.avgLighthouse < 70) {
    recommendations.push(`2. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®æ”¹å–„ãŒå¿…è¦ã§ã™** (å¹³å‡ã‚¹ã‚³ã‚¢: ${summary.avgLighthouse})`);
  }

  if (summary.totalWarnings > 20) {
    recommendations.push(`3. **è­¦å‘Šé …ç›®ã®ç¢ºèªã¨å¯¾å¿œã‚’æ¨å¥¨ã—ã¾ã™** (${summary.totalWarnings}ä»¶ã®è­¦å‘Š)`);
  }

  if (summary.criticalIssues.length > 0) {
    recommendations.push(`4. **é‡è¦ãªå•é¡Œã‚’å„ªå…ˆçš„ã«å¯¾å¿œã—ã¦ãã ã•ã„**`);
  }

  if (recommendations.length === 0) {
    recommendations.push('âœ¨ å¤§ããªå•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚å®šæœŸçš„ãªãƒã‚§ãƒƒã‚¯ã‚’ç¶™ç¶šã—ã¦ãã ã•ã„ã€‚');
  }

  return recommendations.join('\n');
}