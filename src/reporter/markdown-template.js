export function generateMarkdown(report) {
  const { url, date, pages } = report;
  let md = [];

  // ãƒ˜ãƒƒãƒ€ãƒ¼
  md.push(`# Webå“è³ªãƒã‚§ãƒƒã‚¯ãƒ¬ãƒãƒ¼ãƒˆ`);
  md.push('');
  md.push(`**å¯¾è±¡ã‚µã‚¤ãƒˆ:** ${url}`);
  md.push(`**å®Ÿæ–½æ—¥:** ${date}`);
  md.push(`**ãƒã‚§ãƒƒã‚¯ãƒšãƒ¼ã‚¸æ•°:** ${pages.length}ãƒšãƒ¼ã‚¸`);
  md.push('');
  md.push('---');
  md.push('');

  // ã‚µãƒãƒªãƒ¼çµ±è¨ˆ
  const summary = calculateSummary(pages);
  md.push('## ã‚µãƒãƒªãƒ¼');
  md.push('');
  md.push('| é …ç›® | çµæœ |');
  md.push('|------|------|');
  md.push(`| ç·ã‚¨ãƒ©ãƒ¼æ•° | ${summary.totalErrors} |`);
  md.push(`| ç·è­¦å‘Šæ•° | ${summary.totalWarnings} |`);
  md.push(`| OK | ${summary.totalOk} |`);
  if (summary.avgLighthouse !== null) {
    md.push(`| å¹³å‡Lighthouseã‚¹ã‚³ã‚¢ | ${summary.avgLighthouse} |`);
  }
  md.push('');

  // é‡è¦ãªå•é¡Œã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
  if (summary.criticalIssues.length > 0) {
    md.push('### é‡è¦ãªå•é¡Œ');
    md.push('');
    summary.criticalIssues.forEach(issue => {
      md.push(`- ${issue}`);
    });
    md.push('');
  }

  md.push('---');
  md.push('');

  // å„ãƒšãƒ¼ã‚¸ã®è©³ç´°
  md.push('## ãƒšãƒ¼ã‚¸ã”ã¨ã®è©³ç´°');
  md.push('');

  pages.forEach((page, pageIndex) => {
    md.push(`### ${pageIndex + 1}. ${page.path}`);
    md.push('');
    md.push(`**URL:** ${page.url}`);
    md.push(`**ã‚¿ã‚¤ãƒˆãƒ«:** ${page.title || 'N/A'}`);
    md.push('');

    // å„ãƒã‚§ãƒƒã‚¯é …ç›®ã®çµæœ
    page.checks.forEach(check => {
      if (!check) return;

      // Lighthouseç‰¹åˆ¥å‡¦ç†
      if (check.name === 'Lighthouse' && check.rawScores) {
        md.push(`#### ${check.name}`);
        md.push('');
        md.push('| ã‚«ãƒ†ã‚´ãƒª | ã‚¹ã‚³ã‚¢ |');
        md.push('|----------|--------|');
        const categoryNames = {
          'performance': 'Performance',
          'accessibility': 'Accessibility',
          'best-practices': 'Best Practices',
          'seo': 'SEO',
        };
        Object.entries(check.rawScores).forEach(([key, score]) => {
          const label = categoryNames[key] || key;
          const emoji = score >= 90 ? 'ğŸŸ¢' : score >= 50 ? 'ğŸŸ¡' : 'ğŸ”´';
          md.push(`| ${label} | ${emoji} ${score} |`);
        });
        md.push('');
      }

      // items ãƒ™ãƒ¼ã‚¹ã®ãƒã‚§ãƒƒã‚¯çµæœ
      if (check.items && check.items.length > 0) {
        // Lighthouseä»¥å¤–ã¯ã‚¿ã‚¤ãƒˆãƒ«è¡¨ç¤º
        if (!(check.name === 'Lighthouse' && check.rawScores)) {
          md.push(`#### ${check.name}`);
          md.push('');
        }

        check.items.forEach(item => {
          const icon = statusIcon(item.status);
          md.push(`- ${icon} **${item.label}**: ${item.value}`);

          // è©³ç´°ãŒã‚ã‚‹å ´åˆ
          if (item.details && item.details.length > 0) {
            const shown = item.details.slice(0, 10);
            shown.forEach(d => {
              const text = typeof d === 'string' ? d : (d.src || d.issue || JSON.stringify(d));
              md.push(`  - ${text}`);
            });
            if (item.details.length > 10) {
              md.push(`  - ... ä»–${item.details.length - 10}ä»¶`);
            }
          }
        });
        md.push('');
      }

      // è¦‹å‡ºã—ãƒ„ãƒªãƒ¼
      if (check.tree && check.tree.length > 0) {
        md.push('**è¦‹å‡ºã—æ§‹é€ :**');
        check.tree.forEach(h => {
          const indent = '  '.repeat(h.level - 1);
          md.push(`${indent}- ${h.tag}: ${h.text}`);
        });
        md.push('');
      }
    });

    // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæƒ…å ±
    if (page.screenshots && page.screenshots.length > 0) {
      md.push('#### ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ');
      md.push('');
      page.screenshots.forEach(s => {
        md.push(`- ${s.width}px (${s.label})`);
      });
      md.push('');
    }

    md.push('---');
    md.push('');
  });

  // ãƒ•ãƒƒã‚¿ãƒ¼
  md.push('## æ¨å¥¨äº‹é …');
  md.push('');
  md.push(generateRecommendations(summary));
  md.push('');
  md.push('---');
  md.push('');
  md.push(`*Generated by qa-check-tool on ${new Date().toLocaleString('ja-JP')}*`);

  return md.join('\n');
}

function calculateSummary(pages) {
  let totalErrors = 0;
  let totalWarnings = 0;
  let totalOk = 0;
  let lighthouseScores = [];
  let criticalIssues = [];

  pages.forEach(page => {
    page.checks.forEach(check => {
      // items ã‹ã‚‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é›†è¨ˆ
      if (check.items) {
        for (const item of check.items) {
          if (item.status === 'error') totalErrors++;
          else if (item.status === 'warning') totalWarnings++;
          else if (item.status === 'ok') totalOk++;
        }
      }

      // Lighthouseã‚¹ã‚³ã‚¢é›†è¨ˆ
      if (check.name === 'Lighthouse' && check.rawScores) {
        const scores = Object.values(check.rawScores).filter(v => v !== undefined && v !== null);
        if (scores.length > 0) {
          lighthouseScores.push(Math.round(scores.reduce((a, b) => a + b, 0) / scores.length));
        }
      }

      // ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãªå•é¡Œã‚’æ¤œå‡º
      if (check.items) {
        const errors = check.items.filter(i => i.status === 'error');
        if (check.name === 'ã‚³ãƒ³ã‚½ãƒ¼ãƒ«/ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼' && errors.length > 0) {
          criticalIssues.push(`${page.path}: ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ`);
        }
        if (check.name === 'SEO/ãƒ¡ã‚¿æƒ…å ±') {
          const seoErrors = errors.filter(i => ['title', 'meta description'].includes(i.label));
          if (seoErrors.length > 0) {
            criticalIssues.push(`${page.path}: SEOå¿…é ˆè¦ç´ ãŒä¸è¶³ã—ã¦ã„ã¾ã™`);
          }
        }
        if (check.name === 'W3C ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³') {
          const htmlErrors = check.items.find(i => i.label === 'HTML ã‚¨ãƒ©ãƒ¼');
          if (htmlErrors && htmlErrors.status === 'error') {
            criticalIssues.push(`${page.path}: HTMLãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™`);
          }
        }
      }
    });
  });

  const avgLighthouse = lighthouseScores.length > 0
    ? Math.round(lighthouseScores.reduce((a, b) => a + b, 0) / lighthouseScores.length)
    : null;

  return { totalErrors, totalWarnings, totalOk, avgLighthouse, criticalIssues };
}

function statusIcon(status) {
  switch (status) {
    case 'ok': return 'âœ…';
    case 'warning': return 'âš ï¸';
    case 'error': return 'âŒ';
    case 'info': return 'â„¹ï¸';
    default: return 'â“';
  }
}

function generateRecommendations(summary) {
  const recommendations = [];

  if (summary.totalErrors > 0) {
    recommendations.push(`1. **ã‚¨ãƒ©ãƒ¼ã®è§£æ¶ˆã‚’æœ€å„ªå…ˆã§å®Ÿæ–½ã—ã¦ãã ã•ã„** (${summary.totalErrors}ä»¶ã®ã‚¨ãƒ©ãƒ¼)`);
  }

  if (summary.avgLighthouse !== null && summary.avgLighthouse < 70) {
    recommendations.push(`2. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®æ”¹å–„ãŒå¿…è¦ã§ã™** (å¹³å‡ã‚¹ã‚³ã‚¢: ${summary.avgLighthouse})`);
  }

  if (summary.totalWarnings > 20) {
    recommendations.push(`3. **è­¦å‘Šé …ç›®ã®ç¢ºèªã¨å¯¾å¿œã‚’æ¨å¥¨ã—ã¾ã™** (${summary.totalWarnings}ä»¶ã®è­¦å‘Š)`);
  }

  if (summary.criticalIssues.length > 0) {
    recommendations.push(`4. **é‡è¦ãªå•é¡Œã‚’å„ªå…ˆçš„ã«å¯¾å¿œã—ã¦ãã ã•ã„**`);
  }

  if (recommendations.length === 0) {
    recommendations.push('å¤§ããªå•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚å®šæœŸçš„ãªãƒã‚§ãƒƒã‚¯ã‚’ç¶™ç¶šã—ã¦ãã ã•ã„ã€‚');
  }

  return recommendations.join('\n');
}
